# Logseq Checklist Plugin - Continue From Here

**Date:** 2025-12-14
**Current Version:** 0.1.14
**Status:** Debugging datascript query syntax and tag detection

---

## Project Overview

Building a Logseq plugin that automatically adds progress indicators to blocks tagged with `#checklist`, showing completion like `(1/3)` based on child blocks tagged with `#checkbox`.

**Key Implementation Detail:**
- Parent blocks tagged with `#checklist`
- Child blocks tagged with `#checkbox` (NOT markdown checkboxes)
- Checkbox state is a boolean property on `#checkbox` class
- Uses `DB.onChanged` hook for real-time updates

---

## What We've Accomplished

### ‚úÖ Completed

1. **Project Setup (v0.1.0)**
   - Created package.json, tsconfig.json, vite.config.ts
   - Installed dependencies (@logseq/libs ^0.2.8)
   - Set up Vite bundler with vite-plugin-logseq
   - Initialized git repository

2. **Core Algorithm (v0.1.0-0.1.1)**
   - Implemented recursive checkbox counting in `src/progress.ts`
   - Content manipulation utilities in `src/content.ts`
   - Progress indicator formatting: `(checked/total)`
   - Manual slash command: `/Update checklist progress`

3. **Checkbox Detection (v0.1.1)**
   - Updated to detect blocks tagged with `#checkbox` (not markdown)
   - Looks for boolean properties on checkbox blocks
   - Flexible property detection (any boolean, prioritizes names with "checkbox" or "cb")

4. **Event Handling (v0.1.2-0.1.4)**
   - DB.onChanged hook registration
   - Debouncing (300ms) to prevent update thrashing
   - Parent checklist block finder (traverses up tree)
   - Multiple tag detection methods attempted

5. **Bug Fixes**
   - v0.1.2: Fixed `txData.filter is not a function` error
   - v0.1.3: Fixed access to txData from change object structure
   - v0.1.4: Fixed datascript query syntax to use vector format

6. **Tag Detection Attempts**
   - v0.1.7: Added content-based tag detection
   - v0.1.12: Attempted class-based detection with API calls
   - v0.1.13: Rewrote to use datascript queries
   - v0.1.14: Fixed query syntax to use `:find [?block-uuid]`

---

## Current Issue - NEEDS DEBUGGING

### Datascript Query Syntax Error

**Current Error:**
```
Error: Cannot parse :find, expected: (find-rel | find-coll | find-tuple | find-scalar)
```

**What we've tried:**
- v0.1.13: Used `:find ?block-uuid` (single symbol) - FAILED
- v0.1.14: Used `:find [?block-uuid]` (vector) - STILL FAILING

**The Problem:**
The datascript query parser is still rejecting our query format. Despite following the documentation and using the vector format, we're getting the same parsing error.

**Current Query:**
```clojure
{:query [:find [?block-uuid]
         :where
         [?b :block/uuid ?block-uuid]
         [?b :block/tags ?tag]
         [?tag :block/title "checklist"]]}
```

**Key Questions:**
1. Is the query format itself wrong?
2. Are we missing required query parameters?
3. Is there a different way to query for tags in Logseq DB?
4. Should we use a different approach entirely?

---

## Test Setup

### EDN Test File
Located at: `/Users/niyaro/Downloads/logseq_db_checklist dev_1765715717.edn`

**Structure:**
```edn
:properties
  :user.property/cbproperty-O9FVGbdJ  ; The checkbox property
    :logseq.property/type :checkbox
    :block/title "cb property"

:classes
  :user.class/checklist  ; Tag for parent blocks
  :user.class/checkbox   ; Tag for child blocks
    :build/class-properties [:user.property/cbproperty-O9FVGbdJ]

:pages-and-blocks
  - "This is a checklist" #checklist
    - "This is a sub-task" #checkbox
    - "This is another sub-task" #checkbox
```

**Key Data Points:**
- Checkbox property: `:user.property/cbproperty-O9FVGbdJ`
- Checklist class: `:user.class/checklist-SlGqj6-b`
- Checkbox class: `:user.class/checkbox-u8GFj-Ck`
- Tag titles: "checklist" and "checkbox"

### How to Test
1. Import EDN file into Logseq
2. Load plugin: Settings ‚Üí Plugins ‚Üí Load unpacked plugin ‚Üí `/Users/niyaro/Documents/Code/Logseq/logseq-checklist`
3. Verify plugin shows version **0.1.3**
4. Open browser console (check for "Checklist plugin loaded" message)
5. Toggle the "cb property" checkbox on sub-task blocks
6. Watch console for `[DEBUG]` logs

---

## Project Structure

```
/Users/niyaro/Documents/Code/Logseq/logseq-checklist/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # Plugin entry, DB.onChanged setup
‚îÇ   ‚îú‚îÄ‚îÄ progress.ts    # Core algorithm (recursive counting)
‚îÇ   ‚îú‚îÄ‚îÄ events.ts      # Event handling (filter, debounce, find parent)
‚îÇ   ‚îú‚îÄ‚îÄ content.ts     # Content manipulation (add/remove indicators)
‚îÇ   ‚îî‚îÄ‚îÄ types.ts       # TypeScript interfaces
‚îú‚îÄ‚îÄ dist/              # Build output (generated by Vite)
‚îú‚îÄ‚îÄ package.json       # v0.1.14
‚îú‚îÄ‚îÄ CHANGELOG.md       # Full version history
‚îú‚îÄ‚îÄ README.md          # User documentation
‚îî‚îÄ‚îÄ GETTING_STARTED.md # Original planning doc
```

---

## Key Files to Reference

1. **Plan File:** `/Users/niyaro/.claude/plans/shimmying-baking-thompson.md`
   - Complete implementation plan with DB.onChanged strategy

2. **Previous Plan:** `/Users/niyaro/.claude/plans/lovely-mixing-wilkes.md`
   - Detailed algorithm documentation
   - Edge case handling

3. **API Skill:** `/Users/niyaro/.claude/skills/logseq-db-plugin-api-skill/SKILL.md`
   - Line 440: `IDatom` type definition
   - DB.onChanged API reference
   - Datascript query examples

4. **DB Knowledge:** `/Users/niyaro/Documents/Code/Logseq/logseq-db-knowledge/SKILL.md`
   - Tag/class system documentation
   - Query syntax examples
   - Data model reference

5. **Test EDN:** `/Users/niyaro/Downloads/logseq_db_checklist dev_1765715717.edn`
   - Real test data structure

---

## Next Steps - Priority Order

### 1. Debug Datascript Query (HIGHEST PRIORITY)

**Goal:** Fix the datascript query syntax error

**Current Error:**
```
Error: Cannot parse :find, expected: (find-rel | find-coll | find-tuple | find-scalar)
```

**What we've tried:**
- v0.1.13: Used `:find ?block-uuid` (single symbol) - FAILED
- v0.1.14: Used `:find [?block-uuid]` (vector) - STILL FAILING

**Action items:**
- [ ] Review Logseq DB documentation for correct query syntax
- [ ] Check if we're missing required query parameters
- [ ] Try alternative query formats from documentation
- [ ] Test if we can query for tags at all using simpler queries
- [ ] Consider using Logseq API methods instead of datascript

**Key questions:**
- What is the exact correct format for `:find` clause in Logseq DB?
- Are there working query examples we can reference?
- Should we use a completely different approach for tag detection?

**Current query (src/events.ts):**
```typescript
const query = `
{:query [:find [?block-uuid]
         :where
         [?b :block/uuid ?block-uuid]
         [?b :block/tags ?tag]
         [?tag :block/title "${tag}"]]}
`
```

### 2. Test Alternative Tag Detection Methods (MEDIUM PRIORITY)

**Options to try if datascript fails:**
- Use Logseq API methods: `logseq.App.getBlockClasses()`
- Content-based detection: look for `#checklist` in block content
- Property-based detection: check `block.properties.tags`
- Hybrid approach: try multiple methods with fallback

**Action items:**
- [ ] Implement content-based tag detection as fallback
- [ ] Test if `block.properties.tags` contains useful data
- [ ] Try API-based class detection with proper error handling
- [ ] Add comprehensive logging for each detection method

### 3. Verify Data Structure (LOW PRIORITY)

**Action items:**
- [ ] Use Logseq console to inspect actual block structure
- [ ] Check how tags are stored in the database
- [ ] Verify tag keywords vs tag titles
- [ ] Understand the relationship between classes and tags
- [ ] Test queries in Logseq console first before implementing

### 4. Test End-to-End Flow (ON HOLD)

Once tag detection works:
- [ ] Verify progress indicators appear: `(0/2)`, `(1/2)`, `(2/2)`
- [ ] Test nested checklists
- [ ] Test rapid toggling (debouncing)
- [ ] Test manual command
- [ ] Remove debug logging for production

### 4. Polish & Release

- [ ] Remove or reduce debug logging
- [ ] Add user settings (optional)
- [ ] Final testing with various edge cases
- [ ] Publish to Logseq marketplace (optional)

---

## Known Issues / Questions

### Issue 1: Datascript Query Syntax
**Status:** BLOCKED (v0.1.14)
**Problem:** Query parser rejects our format despite following documentation
**Error:** "Cannot parse :find, expected: (find-rel | find-coll | find-tuple | find-scalar)"
**Tried:** Both single symbol and vector formats - both fail

### Issue 2: Tag Detection Approach
**Status:** UNCERTAIN
**Problem:** Don't know the correct way to detect tags in Logseq DB
**Options tried:**
- Content-based: works but tags not in content
- Property-based: `block.properties.tags` is undefined
- Class-based: API methods don't exist or fail
- Datascript: query syntax rejected

### Issue 3: Data Structure Understanding
**Status:** NEEDS RESEARCH
**Problem:** Need to understand how tags are actually stored
**Questions:**
- Are tags in `:block/tags` or somewhere else?
- How to map tag keywords to tag titles?
- What API methods are available for tag access?

### Issue 4: Query Testing
**Status:** NOT TESTED
**Problem:** Need to test queries in Logseq console first
**Action:** Try simple queries to understand what works

---

## Important Context from CLAUDE.md

**Procedures to follow:**
1. ‚úÖ Update version number with EVERY build iteration
2. ‚úÖ Update CHANGELOG.md for each version
3. ‚úÖ Commit to git after each version
4. ‚ùå NOT pushed to remote yet (local repository only)

**User preferences:**
- Fish shell (not bash)
- Default code directory: `/Users/niyaro/Documents/Code`
- Prefers simple solutions over complex ones
- Load `logseq-db-plugin-api-skill` before starting

**Key learnings:**
- Checkbox detection works perfectly
- Tag detection is the main issue
- Datascript queries are failing with syntax errors
- Need to find alternative tag detection methods

---

## Commands to Run Tomorrow

### Start fresh conversation with:
```
Load this file to continue where we left off:
/Users/niyaro/Documents/Code/Logseq/logseq-checklist/CONTINUE_HERE.md

Then load both skills:
load the logseq-db-plugin-api skill
load the logseq-db-knowledge skill
```

### Useful commands:
```bash
# Rebuild plugin
cd /Users/niyaro/Documents/Code/Logseq/logseq-checklist
pnpm run build

# Watch mode for development
pnpm run dev

# Check version
cat package.json | grep version

# View recent commits
git log --oneline -5

# Test simple datascript query in Logseq console
# Try to understand what query format works
```

---

## Quick Reference: Current State

**What works:**
- ‚úÖ Checkbox detection (property changes)
- ‚úÖ Checkbox state reading
- ‚úÖ Parent traversal logic
- ‚úÖ Progress calculation
- ‚úÖ Content manipulation

**What's broken:**
- ‚ùå Tag detection (datascript query syntax error)
- ‚ùå Finding parent checklist blocks
- ‚ùå Complete end-to-end flow

**Current bottleneck:** Datascript query syntax

---

## Debug Checklist for Tomorrow

When you resume:
- [ ] Verify plugin version shows 0.1.14 in Logseq
- [ ] Open browser console before testing
- [ ] Toggle a checkbox and capture ALL console output
- [ ] Look specifically for datascript query errors
- [ ] Test simple queries in Logseq console first
- [ ] Try alternative tag detection methods
- [ ] Research correct datascript query syntax
- [ ] Check Logseq DB documentation examples

---

## Contact Info / Resources

- **Project location:** `/Users/niyaro/Documents/Code/Logseq/logseq-checklist`
- **Git status:** Initialized, 2 commits, not pushed to remote
- **Latest commit:** "v0.1.3 - Fixed DB.onChanged to access txData from change object"
- **Build tool:** Vite 7.2.7
- **Node package manager:** pnpm

---

**Ready to continue!** Load this file tomorrow and we'll debug the DB.onChanged filtering logic. üöÄ
