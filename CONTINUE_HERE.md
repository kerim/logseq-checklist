# Logseq Checklist Plugin - Continue From Here

**Date:** 2025-12-14
**Current Version:** 0.1.3
**Status:** Debugging DB.onChanged event handling

---

## Project Overview

Building a Logseq plugin that automatically adds progress indicators to blocks tagged with `#checklist`, showing completion like `(1/3)` based on child blocks tagged with `#checkbox`.

**Key Implementation Detail:**
- Parent blocks tagged with `#checklist`
- Child blocks tagged with `#checkbox` (NOT markdown checkboxes)
- Checkbox state is a boolean property on `#checkbox` class
- Uses `DB.onChanged` hook for real-time updates

---

## What We've Accomplished

### ‚úÖ Completed

1. **Project Setup (v0.1.0)**
   - Created package.json, tsconfig.json, vite.config.ts
   - Installed dependencies (@logseq/libs ^0.2.8)
   - Set up Vite bundler with vite-plugin-logseq
   - Initialized git repository

2. **Core Algorithm (v0.1.0-0.1.1)**
   - Implemented recursive checkbox counting in `src/progress.ts`
   - Content manipulation utilities in `src/content.ts`
   - Progress indicator formatting: `(checked/total)`
   - Manual slash command: `/Update checklist progress`

3. **Checkbox Detection (v0.1.1)**
   - Updated to detect blocks tagged with `#checkbox` (not markdown)
   - Looks for boolean properties on checkbox blocks
   - Flexible property detection (any boolean, prioritizes names with "checkbox" or "cb")

4. **Event Handling (v0.1.2-0.1.3)**
   - DB.onChanged hook registration
   - Debouncing (300ms) to prevent update thrashing
   - Parent checklist block finder (traverses up tree)

5. **Bug Fixes**
   - v0.1.2: Fixed `txData.filter is not a function` error
   - v0.1.3: Fixed access to txData from change object structure

---

## Current Issue - NEEDS DEBUGGING

### DB.onChanged Data Format

**What we learned:**
The `DB.onChanged` hook receives an **object**, not an array:

```javascript
{
  blocks: Array(2),
  deletedAssets: Array(0),
  deletedBlockUuids: Array(0),
  txData: Array(8),  // ‚Üê The actual transaction datoms
  txMeta: {...}
}
```

**Latest fix (v0.1.3):**
- Changed handler to access `changeData.txData` instead of treating the whole thing as an array
- Added comprehensive debug logging throughout

**What to test next:**
1. Load plugin v0.1.3 in Logseq
2. Create/load test graph from: `/Users/niyaro/Downloads/logseq_db_checklist dev_1765715717.edn`
3. Toggle checkbox property on a `#checkbox` block
4. Check console for debug output:
   - `[DEBUG] DB.onChanged received:` - should show the change object
   - `[DEBUG] txData array length:` - should show number of datoms
   - `[DEBUG] No checkbox changes detected` OR `[DEBUG] Found checkbox changes:`

---

## Test Setup

### EDN Test File
Located at: `/Users/niyaro/Downloads/logseq_db_checklist dev_1765715717.edn`

**Structure:**
```edn
:properties
  :user.property/cbproperty-O9FVGbdJ  ; The checkbox property
    :logseq.property/type :checkbox
    :block/title "cb property"

:classes
  :user.class/checklist  ; Tag for parent blocks
  :user.class/checkbox   ; Tag for child blocks
    :build/class-properties [:user.property/cbproperty-O9FVGbdJ]

:pages-and-blocks
  - "This is a checklist" #checklist
    - "This is a sub-task" #checkbox
    - "This is another sub-task" #checkbox
```

### How to Test
1. Import EDN file into Logseq
2. Load plugin: Settings ‚Üí Plugins ‚Üí Load unpacked plugin ‚Üí `/Users/niyaro/Documents/Code/Logseq/logseq-checklist`
3. Verify plugin shows version **0.1.3**
4. Open browser console (check for "Checklist plugin loaded" message)
5. Toggle the "cb property" checkbox on sub-task blocks
6. Watch console for `[DEBUG]` logs

---

## Project Structure

```
/Users/niyaro/Documents/Code/Logseq/logseq-checklist/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # Plugin entry, DB.onChanged setup
‚îÇ   ‚îú‚îÄ‚îÄ progress.ts    # Core algorithm (recursive counting)
‚îÇ   ‚îú‚îÄ‚îÄ events.ts      # Event handling (filter, debounce, find parent)
‚îÇ   ‚îú‚îÄ‚îÄ content.ts     # Content manipulation (add/remove indicators)
‚îÇ   ‚îî‚îÄ‚îÄ types.ts       # TypeScript interfaces
‚îú‚îÄ‚îÄ dist/              # Build output (generated by Vite)
‚îú‚îÄ‚îÄ package.json       # v0.1.3
‚îú‚îÄ‚îÄ CHANGELOG.md       # Full version history
‚îú‚îÄ‚îÄ README.md          # User documentation
‚îî‚îÄ‚îÄ GETTING_STARTED.md # Original planning doc
```

---

## Key Files to Reference

1. **Plan File:** `/Users/niyaro/.claude/plans/shimmying-baking-thompson.md`
   - Complete implementation plan with DB.onChanged strategy

2. **Previous Plan:** `/Users/niyaro/.claude/plans/lovely-mixing-wilkes.md`
   - Detailed algorithm documentation
   - Edge case handling

3. **API Skill:** `/Users/niyaro/.claude/skills/logseq-db-plugin-api-skill/SKILL.md`
   - Line 440: `IDatom` type definition
   - DB.onChanged API reference

4. **Test EDN:** `/Users/niyaro/Downloads/logseq_db_checklist dev_1765715717.edn`
   - Real test data structure

---

## Next Steps - Priority Order

### 1. Debug DB.onChanged (HIGHEST PRIORITY)

**Goal:** Understand why checkbox changes aren't being detected

**Action items:**
- [ ] Load v0.1.3 plugin in Logseq
- [ ] Toggle checkbox on a `#checkbox` block
- [ ] Review console logs to see:
  - Is `txData` being received?
  - What does the `txData` array contain?
  - Is `isCheckboxChange()` filtering correctly?

**Key questions:**
- What attribute name is used for checkbox properties in datoms?
- Is it `:user.property/cbproperty-O9FVGbdJ` or something else?
- Does the attribute include "checkbox" in its name?

**Current filter logic (src/events.ts:18-25):**
```typescript
export function isCheckboxChange(datom: IDatom): boolean {
  const [, attribute] = datom
  return attribute.includes('checkbox')
}
```

This might need adjustment based on actual attribute names!

### 2. Fix Checkbox Property Detection (MEDIUM PRIORITY)

**Current approach (src/progress.ts:21-55):**
- Looks for any boolean property on `#checkbox` blocks
- Prioritizes properties with "checkbox" or "cb" in the name

**Potential issue:**
- Property name might be "cb property" (with space)
- Property key might be fully namespaced: `:user.property/cbproperty-O9FVGbdJ`
- Need to see actual property structure via debug logs

**Action items:**
- [ ] Use `/Update checklist progress` manual command
- [ ] Check console for `[DEBUG] Checkbox block properties:` logs
- [ ] Verify property keys and values
- [ ] Adjust `getCheckboxValue()` logic if needed

### 3. Test End-to-End Flow

Once checkbox detection works:
- [ ] Verify progress indicators appear: `(0/2)`, `(1/2)`, `(2/2)`
- [ ] Test nested checklists
- [ ] Test rapid toggling (debouncing)
- [ ] Test manual command
- [ ] Remove debug logging for production

### 4. Polish & Release

- [ ] Remove or reduce debug logging
- [ ] Add user settings (optional)
- [ ] Final testing with various edge cases
- [ ] Publish to Logseq marketplace (optional)

---

## Known Issues / Questions

### Issue 1: DB.onChanged Filtering
**Status:** In progress (v0.1.3)
**Problem:** Need to verify checkbox property changes are detected
**Debug:** Added extensive logging to understand data flow

### Issue 2: Property Name Detection
**Status:** Unknown
**Problem:** Don't know exact property key format when reading blocks
**Debug:** Added logging in `getCheckboxValue()`

### Issue 3: Entity ID to UUID Conversion
**Status:** Untested
**Code:** `logseq.Editor.getBlock(entityId)` in events.ts:123
**Question:** Does `getBlock()` accept entity IDs or only UUIDs?

---

## Important Context from CLAUDE.md

**Procedures to follow:**
1. ‚úÖ Update version number with EVERY build iteration
2. ‚úÖ Update CHANGELOG.md for each version
3. ‚úÖ Commit to git after each version
4. ‚ùå NOT pushed to remote yet (local repository only)

**User preferences:**
- Fish shell (not bash)
- Default code directory: `/Users/niyaro/Documents/Code`
- Prefers simple solutions over complex ones
- Load `logseq-db-plugin-api-skill` before starting

---

## Commands to Run Tomorrow

### Start fresh conversation with:
```
Load this file to continue where we left off:
/Users/niyaro/Documents/Code/Logseq/logseq-checklist/CONTINUE_HERE.md

Then load the API skill:
load the logseq-db-plugin-api skill
```

### Useful commands:
```bash
# Rebuild plugin
cd /Users/niyaro/Documents/Code/Logseq/logseq-checklist
pnpm run build

# Watch mode for development
pnpm run dev

# Check version
cat package.json | grep version

# View recent commits
git log --oneline -5
```

---

## Quick Reference: Checkbox Detection Logic

**How it should work:**
1. User toggles checkbox property on block tagged with `#checkbox`
2. `DB.onChanged` fires with change object
3. Extract `changeData.txData` array
4. Filter for datoms where attribute contains "checkbox"
5. Get entity ID from datom
6. Convert entity ID to block
7. Find parent block tagged with `#checklist`
8. Recalculate progress for that checklist
9. Update block content with new `(X/Y)` indicator

**Current bottleneck:** Step 4 - filtering datoms

---

## Debug Checklist for Tomorrow

When you resume:
- [ ] Verify plugin version shows 0.1.3 in Logseq
- [ ] Open browser console before testing
- [ ] Toggle a checkbox and capture ALL console output
- [ ] Look specifically for `[DEBUG]` prefixed logs
- [ ] Share the txData array contents
- [ ] Share the datom structure (what attributes are used)
- [ ] Test manual command: `/Update checklist progress`
- [ ] Capture checkbox property structure logs

---

## Contact Info / Resources

- **Project location:** `/Users/niyaro/Documents/Code/Logseq/logseq-checklist`
- **Git status:** Initialized, 2 commits, not pushed to remote
- **Latest commit:** "v0.1.3 - Fixed DB.onChanged to access txData from change object"
- **Build tool:** Vite 7.2.7
- **Node package manager:** pnpm

---

**Ready to continue!** Load this file tomorrow and we'll debug the DB.onChanged filtering logic. üöÄ
